SEQUENCE DIAGRAM FOR FIGMA
==========================

Actors:
-------
1. User (actor - stick figure icon, no lifeline)

Components (with lifelines):
----------------------------
1. Frontend (React/Vite)
2. Backend (Flask API)
3. Cohere AI (NLP)
4. Supabase (Database)
5. Pexels API (Images)

MAIN SEARCH FLOW:
-----------------

Step 1: User → Frontend (solid arrow)
   Function Call: searchCars(query: string)
   Location: View/src/services/api.ts
   Parameter: "red SUV under $30k"
   [Activate Frontend - vertical bar starts]
   
Step 2: Frontend → Backend (solid arrow)
   Function Call: POST /api/search
   Handler Function: search()
   Location: Controller/api_server.py
   Parameter: {query: "red SUV under $30k"}
   [Activate Backend - vertical bar starts]
   
Step 3: Backend → Cohere AI (solid arrow)
   Function Call: co.chat(messages)
   Internal Function: aiSearch(prompt: str)
   Location: Controller/api_server.py
   Parameter: Enhanced prompt with car search instructions
   [Activate Cohere - vertical bar starts]
   
Step 4: Cohere AI → Backend (DOTTED arrow - return)
   Return Function: response.text
   Return Value: parsed_params
   Type: dict
   Value: {make: null, price: 30000, bodyType: "SUV", color: "red"}
   [Deactivate Cohere - vertical bar ends]
   
Step 5: Backend → Supabase (solid arrow)
   Function Call: sortDB(maximumPrice, maximumMileage, color, make, model, minYear, maxYear, carType)
   Method Chain: query.select('*').limit(10).execute()
   Location: Controller/api_server.py
   SQL Equivalent: SELECT * FROM CarListings WHERE price <= 30000 AND body_type ILIKE '%SUV%' LIMIT 10
   [Activate Supabase - vertical bar starts]
   
Step 6: Supabase → Backend (DOTTED arrow - return)
   Return Function: response.data
   Return Value: cars[]
   Type: list[dict]
   Value: [{id: 1, make: "Toyota", model: "RAV4", year: 2020, price: 28000, ...}, ...]
   [Deactivate Supabase - vertical bar ends]
   
Step 7: Backend → Pexels API (solid arrow - inside LOOP)
   Function Call: get_car_image_url(make: str, model: str, year: int, color: str)
   Internal Function: requests.get(url, params, headers)
   Location: Controller/api_server.py
   Parameter: "2020 Toyota RAV4 red automobile car vehicle"
   [Activate Pexels - vertical bar starts]
   
Step 8: Pexels API → Backend (DOTTED arrow - return, inside LOOP)
   Return Function: response.json()
   Return Value: image_url
   Type: str
   Value: "https://images.pexels.com/photos/..."
   [Deactivate Pexels - vertical bar ends]
   [LOOP: Repeat steps 7-8 for each car, max 10 times]
   
Step 9: Backend → Backend (self-call, solid arrow)
   Function Call: format_car_results(cars: list[dict])
   Location: Controller/api_server.py
   Internal processing:
   - get_color_hex(color_name)
   - get_car_image_url(make, model, year, color)
   - Filter out "gas" and "unknown" values
   [Backend activation continues]
   
Step 10: Backend → Frontend (DOTTED arrow - return)
   Return Function: jsonify(data)
   Return Value: response_data
   Type: dict
   Value: {
     cars: [{...formatted car objects...}],
     count: 10,
     hasMore: true,
     totalCount: 25,
     message: "Showing 10 of 25 results..."
   }
   [Deactivate Backend - vertical bar ends]
   
Step 11: Frontend → Frontend (self-call, solid arrow)
   Function Call: normalizeCar(car: any)
   Location: View/src/services/api.ts
   Internal processing:
   - Process response data
   - Normalize car structure
   - Update React state
   [Frontend activation continues]
   
Step 12: Frontend displays results (END - no return arrow)
   Function Call: render CarCard[]
   Component: CarCard.tsx
   Display: Car cards with images, details, and filters
   [Deactivate Frontend - vertical bar ends]
   [Flow ends here - User views results in Frontend UI]

FILTER-BASED SEARCH FLOW:
-------------------------

Step 1: User → Frontend (solid arrow)
   Function Call: searchCarsWithFilters(filters: Filters)
   Location: View/src/services/api.ts
   Parameter: {makes: ["Toyota"], maxPrice: 30000, bodyTypes: ["SUV"]}
   [Activate Frontend - vertical bar starts]
   
Step 2: Frontend → Backend (solid arrow)
   Function Call: POST /api/search/filtered
   Handler Function: filtered_search()
   Location: Controller/api_server.py
   Parameter: {filters: {makes: ["Toyota"], maxPrice: 30000, bodyTypes: ["SUV"]}}
   [Activate Backend - vertical bar starts]
   
Step 3: Backend → Supabase (solid arrow)
   Function Call: sortDB(maximumPrice, maximumMileage, color, make, model, minYear, maxYear, carType)
   Method Chain: query.select('*').limit(10).execute()
   Location: Controller/api_server.py
   [Activate Supabase - vertical bar starts]
   
Step 4: Supabase → Backend (DOTTED arrow - return)
   Return Function: response.data
   Return Value: cars[]
   Type: list[dict]
   Value: [{id: 1, make: "Toyota", model: "RAV4", ...}, ...]
   [Deactivate Supabase - vertical bar ends]
   
Step 5: Backend → Pexels API (solid arrow - inside LOOP)
   Function Call: get_car_image_url(make, model, year, color)
   Internal Function: requests.get(search_url)
   [Activate Pexels - vertical bar starts]
   
Step 6: Pexels API → Backend (DOTTED arrow - return, inside LOOP)
   Return Function: response.json()
   Return Value: image_url
   Type: str
   [Deactivate Pexels - vertical bar ends]
   [LOOP: Repeat steps 5-6 for each car, max 10 times]
   
Step 7: Backend → Backend (self-call, solid arrow)
   Function Call: format_car_results(cars)
   Internal processing:
   - get_color_hex(color_name)
   - Add imageUrl to each car
   [Backend activation continues]
   
Step 8: Backend → Frontend (DOTTED arrow - return)
   Return Function: jsonify(data)
   Return Value: response_data
   Type: dict
   Value: {cars: [...], count: 10, hasMore: true, totalCount: 25}
   [Deactivate Backend - vertical bar ends]
   
Step 9: Frontend → Frontend (self-call, solid arrow)
   Function Call: normalizeCar(car)
   Location: View/src/services/api.ts
   Internal processing:
   - Process response data
   - Normalize car structure
   [Frontend activation continues]
   
Step 10: Frontend displays results (END - no return arrow)
   Function Call: render CarCard[]
   Component: CarCard.tsx
   Display: Filtered car results with images
   [Deactivate Frontend - vertical bar ends]
   [Flow ends here - User views results in Frontend UI]

NOTES FOR FIGMA:
---------------
- Use stick figure icon for User (actor, not a component)
- Use rectangles for components (Frontend, Backend, etc.)
- Use solid arrows (→) for function calls
- Use dotted arrows (-->>) for return values (but NOT back to User)
- Flow ends at Frontend - no return arrows to User
- User views results through Frontend UI (no arrow needed)
- Label arrows with function names and parameters
- Use different colors for request/response
- Add activation boxes (vertical bars) on components during processing
- Include loop notation for "For each car" steps
- Add notes for internal processing steps
- Show function locations (file paths) as annotations

FUNCTION CALL FORMAT:
--------------------
Each step should show:
1. Function name (e.g., searchCars, co.chat, sortDB)
2. Parameters in parentheses
3. Return type (for dotted arrows)
4. File location (optional annotation)
